<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MyMangaApp.ViewModels"
             x:Class="MyMangaApp.Views.DownloadsView"
             x:DataType="vm:DownloadsViewModel"
             Background="{DynamicResource PrimaryBackground}">
    
    <Grid RowDefinitions="Auto, *">
        <!-- Header Actions -->
        <Border Grid.Row="0" Padding="40,30,40,20" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="0,0,0,1"
                IsVisible="{Binding HasDownloads}">
            <Grid ColumnDefinitions="*, Auto">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="15">
                        <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" FontSize="28" 
                                   Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"
                                   RenderOptions.TextRenderingMode="Antialias"/>
                        <TextBlock Text="Downloads" FontSize="32" FontWeight="Bold" Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Text="{Binding QueueCount, StringFormat='{}{0} items in queue'}" Foreground="{DynamicResource SecondaryText}" FontSize="14" Margin="0,5,0,0"
                               IsVisible="{Binding HasQueue}"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                    <Button Command="{Binding ResumeAllCommand}" Background="#A6E3A1" Foreground="#1E1E2E" FontWeight="Bold" CornerRadius="20" Padding="15,8">
                         <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="&#xE768;" FontFamily="Segoe Fluent Icons" VerticalAlignment="Center"/>
                            <TextBlock Text="Resume" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding PauseAllCommand}" Background="{DynamicResource SidebarBackground}" Foreground="{DynamicResource PrimaryText}" CornerRadius="20" Padding="15,8">
                         <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="&#xE769;" FontFamily="Segoe Fluent Icons" VerticalAlignment="Center"/>
                            <TextBlock Text="Pause" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding ClearCompletedCommand}" Background="{DynamicResource SidebarBackground}" Foreground="#F38BA8" CornerRadius="20" Padding="15,8">
                         <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="&#xE74D;" FontFamily="Segoe Fluent Icons" VerticalAlignment="Center"/>
                            <TextBlock Text="Clear" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- List Content (ListBox for Virtualization + Built-in Scroll) -->
        <ListBox Grid.Row="1" ItemsSource="{Binding QueuedItems}" 
                 Background="Transparent" BorderThickness="0"
                 Padding="40"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 IsVisible="{Binding HasDownloads}">
            
            <ListBox.Styles>
                <!-- Disable Selection Highlight -->
                <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="BorderThickness" Value="0"/>
                </Style>
                <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected:pointerover /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
                <Style Selector="ListBoxItem:selected:focus /template/ ContentPresenter">
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
            </ListBox.Styles>

            <ListBox.ItemTemplate>
                <DataTemplate>
                     <Border Background="{DynamicResource SidebarBackground}" CornerRadius="12" Padding="20" Margin="0,0,0,15"
                             BoxShadow="0 4 10 0 #20000000">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Save as CBZ" Command="{Binding ExportCommand}">
                                    <MenuItem.Icon>
                                        <TextBlock Text="&#xE74E;" FontFamily="Segoe Fluent Icons"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid ColumnDefinitions="60, *, Auto">
                            <Border Grid.Column="0" Width="50" Height="70" Background="{DynamicResource OverlayBackground}" CornerRadius="6" ClipToBounds="True">
                                 <Panel>
                                     <TextBlock Text="IMG" Foreground="{DynamicResource SecondaryText}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                     <Image Source="{Binding CoverBitmap}" Stretch="UniformToFill" IsVisible="{Binding CoverBitmap, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                 </Panel>
                            </Border>
                            
                            <StackPanel Grid.Column="1" Margin="20,0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Title}" Foreground="{DynamicResource PrimaryText}" FontWeight="Bold" FontSize="16"/>
                                <TextBlock Text="{Binding ChapterName}" Foreground="{DynamicResource SecondaryText}" FontSize="14" Margin="0,2,0,8"/>
                                
                                <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding IsActive}" VerticalAlignment="Center">
                                     <ProgressBar Value="{Binding Progress}" Maximum="100" Height="6" Width="200"
                                             Background="{DynamicResource OverlayBackground}" Foreground="{Binding StatusColor}" CornerRadius="3"
                                             IsIndeterminate="{Binding IsIndeterminate}"
                                             VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Progress, StringFormat='{}{0}%'}" Foreground="{Binding StatusColor}" FontSize="12" FontWeight="SemiBold"/>
                                </StackPanel>
                                
                                <TextBlock Text="{Binding Status}" Foreground="{Binding StatusColor}" FontSize="12" IsVisible="{Binding !IsActive}"/>
                            </StackPanel>

                            <Button Grid.Column="2" Command="{Binding CancelCommand}" Background="Transparent" Foreground="#F38BA8"
                                    ToolTip.Tip="Cancel Download" Padding="10" CornerRadius="20">
                                <TextBlock Text="&#xE711;" FontFamily="Segoe Fluent Icons" FontSize="18"/>
                            </Button>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- EMPTY STATE -->
        <!-- EMPTY STATE -->
        <StackPanel Grid.Row="0" Grid.RowSpan="2" VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20"
                    IsVisible="{Binding !HasDownloads}">
            <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#45475A" HorizontalAlignment="Center"/>
            <StackPanel Spacing="8">
                <TextBlock Text="No Downloads Yet" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                <TextBlock Text="Downloaded chapters will appear here." FontSize="14" Foreground="{DynamicResource SecondaryText}" HorizontalAlignment="Center"/>
            </StackPanel>
        </StackPanel>
    </Grid>
</UserControl>
