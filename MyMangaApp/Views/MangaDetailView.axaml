<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MyMangaApp.ViewModels"
             x:Class="MyMangaApp.Views.MangaDetailView"
             x:DataType="vm:MangaDetailViewModel"
             Background="#1E1E2E">

    <UserControl.Styles>
        <Style Selector="Button.BackBtn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="CornerRadius" Value="20"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.2"/>
                    <BrushTransition Property="Foreground" Duration="0:0:0.2"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.BackBtn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#FF9900"/>
            <Setter Property="Foreground" Value="#1E1E2E"/>
        </Style>
        <Style Selector="Button.BackBtn:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.05)"/>
        </Style>
        
        <Style Selector="TextBlock.Unread">
             <Setter Property="Foreground" Value="White"/>
             <Setter Property="FontWeight" Value="Bold"/>
        </Style>
        <Style Selector="TextBlock.Read">
             <Setter Property="Foreground" Value="#7F849C"/>
             <Setter Property="FontWeight" Value="Normal"/>
        </Style>
        
        <!-- ListBox Item Stlying to mimic ItemsControl look but virtualized -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- Loader Styles (CSS Replication: Rotating Circle) -->
        <Style Selector="Border.Loader">
            <Setter Property="Width" Value="50"/>
            <Setter Property="Height" Value="50"/>
            <Setter Property="CornerRadius" Value="25"/>
            <Setter Property="BorderThickness" Value="8"/>
            <Setter Property="RenderTransform">
                 <RotateTransform />
            </Setter>
            <Setter Property="BorderBrush">
                <ConicGradientBrush>
                    <GradientStop Offset="0" Color="LightBlue"/>
                    <GradientStop Offset="0.75" Color="LightBlue"/>
                    <GradientStop Offset="0.7501" Color="Orange"/>
                    <GradientStop Offset="1" Color="Orange"/>
                </ConicGradientBrush>
            </Setter>
            <Style.Animations>
                <Animation Duration="0:0:1" IterationCount="Infinite"> 
                    <KeyFrame Cue="0%">
                        <Setter Property="RotateTransform.Angle" Value="0"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="RotateTransform.Angle" Value="360"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <!-- Main Layout: Virtualized ListBox -->
    <ListBox ItemsSource="{Binding DisplayItems}" Background="Transparent" Margin="0" Padding="0">
        <ListBox.Styles>
            <Style Selector="ListBoxItem">
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Margin" Value="0"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Template">
                    <ControlTemplate>
                        <ContentPresenter Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"
                                          BorderThickness="{TemplateBinding BorderThickness}"
                                          CornerRadius="{TemplateBinding CornerRadius}"
                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                          Content="{TemplateBinding Content}"
                                          Padding="{TemplateBinding Padding}"
                                          HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                          VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"/>
                    </ControlTemplate>
                </Setter>
            </Style>
        </ListBox.Styles>

        <ListBox.DataTemplates>
            <!-- HEADER TEMPLATE -->
            <DataTemplate DataType="vm:MangaDetailHeader">
                <StackPanel Margin="40" Spacing="20">
                    <!-- Back Button and Actions -->
                    <Grid ColumnDefinitions="Auto, *, Auto, Auto">
                        <Button Classes="BackBtn" Click="OnBackClick">
                            <TextBlock Text="&#xE72B;" FontFamily="Segoe Fluent Icons" FontSize="20" VerticalAlignment="Center"/>
                        </Button>
                                
                        <!-- Refresh Button -->
                        <Button Grid.Column="2" 
                                Command="{Binding ViewModel.RefreshCommand}"
                                Background="#313244" Foreground="#FF9900" 
                                Padding="10" CornerRadius="20" Margin="0,0,10,0"
                                ToolTip.Tip="Refresh Details">
                            <TextBlock Text="&#xE72C;" FontFamily="Segoe Fluent Icons" FontSize="16" VerticalAlignment="Center"/>
                        </Button>

                        <Button Grid.Column="3" 
                                Command="{Binding ViewModel.ToggleLibraryCommand}"
                                Background="#313244" Foreground="#F38BA8" Padding="15,8" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="&#xEB51;" FontFamily="Segoe Fluent Icons" IsVisible="{Binding !ViewModel.InLibrary}" FontSize="16" VerticalAlignment="Center"/>
                                <TextBlock Text="&#xEB52;" FontFamily="Segoe Fluent Icons" IsVisible="{Binding ViewModel.InLibrary}" FontSize="16" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ViewModel.InLibrary, Converter={x:Static ObjectConverters.IsNull}}" IsVisible="False"/> 
                                <TextBlock Text="Add to Library" IsVisible="{Binding !ViewModel.InLibrary}" FontWeight="SemiBold"/>
                                <TextBlock Text="In Library" IsVisible="{Binding ViewModel.InLibrary}" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                    
                    <!-- Manga Info Header -->
                    <Grid ColumnDefinitions="200, *" Margin="0,20,0,0">
                        <!-- Cover -->
                        <Border Grid.Column="0" Width="180" Height="270" CornerRadius="8" 
                                Background="#313244" ClipToBounds="True">
                             <Panel>
                                 <!-- Loading State: Skeleton + Spinner -->
                                 <Panel IsVisible="{Binding ViewModel.CoverBitmap, Converter={x:Static ObjectConverters.IsNull}}">
                                     <Border Classes="Skeleton" Background="#313244" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                                     <!-- New Loader -->
                                     <Border Classes="Loader" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                 </Panel>
                                 
                                 <!-- Actual Image -->
                                 <Image Source="{Binding ViewModel.CoverBitmap}" Stretch="UniformToFill"/>
                             </Panel>
                        </Border>

                        <!-- Info -->
                        <StackPanel Grid.Column="1" Margin="30,0,0,0" Spacing="10">
                            <TextBlock Text="{Binding ViewModel.Title}" FontSize="28" FontWeight="Bold" 
                                       Foreground="White" TextWrapping="Wrap"/>
                            <TextBlock Text="{Binding ViewModel.Author}" Foreground="#CDD6F4" FontSize="14"/>
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{Binding ViewModel.Status}" Foreground="#A6E3A1" FontSize="14" VerticalAlignment="Center"/>
                                
                                <!-- OFFLINE Badge -->
                                <Border CornerRadius="4" Background="#FF9900" Padding="8,4" 
                                        IsVisible="{Binding !ViewModel.IsOnline}">
                                    <StackPanel Orientation="Horizontal" Spacing="5">
                                        <TextBlock Text="&#xEA8F;" FontFamily="Segoe Fluent Icons" Foreground="#1E1E2E" FontSize="12" VerticalAlignment="Center"/>
                                        <TextBlock Text="OFFLINE MODE" Foreground="#1E1E2E" FontSize="11" 
                                                   FontWeight="Bold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- RED Badge (Ecchi/Explicit) -->
                                <Border CornerRadius="6" Background="#20F38BA8" 
                                        BorderBrush="#F38BA8" BorderThickness="1"
                                        Padding="10,4" 
                                        IsVisible="{Binding ViewModel.IsExplicitContent}">
                                    <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                        <TextBlock Text="&#xE7BA;" FontFamily="Segoe Fluent Icons" 
                                                   Foreground="#F38BA8" FontSize="14" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                        <TextBlock Text="{Binding ViewModel.MatureWarningText}" 
                                                   Foreground="#F38BA8" FontSize="12" 
                                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- YELLOW Badge (Mature) -->
                                <Border CornerRadius="6" Background="#20F9E2AF" 
                                        BorderBrush="#F9E2AF" BorderThickness="1"
                                        Padding="10,4" 
                                        IsVisible="{Binding !ViewModel.IsExplicitContent}">
                                    <Border.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="ViewModel.IsMatureContent"/>
                                            <Binding Path="!ViewModel.IsExplicitContent"/>
                                        </MultiBinding>
                                    </Border.IsVisible>
                                    <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                                        <TextBlock Text="&#xE7BA;" FontFamily="Segoe Fluent Icons" 
                                                   Foreground="#F9E2AF" FontSize="14" VerticalAlignment="Center" Margin="0,1,0,0"/>
                                        <TextBlock Text="{Binding ViewModel.MatureWarningText}" 
                                                   Foreground="#F9E2AF" FontSize="12" 
                                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                            
                            <!-- Genre Section (Moved Here) -->
                            <ItemsControl ItemsSource="{Binding ViewModel.Genres}" Margin="0,15,0,0">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="15" Background="#313244" Padding="12,6" Margin="0,0,8,8">
                                            <TextBlock Text="{Binding}" Foreground="#FF9900" FontSize="12"/>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Tags -->
                            <ItemsControl ItemsSource="{Binding ViewModel.Tags}" Margin="0,10,0,0">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="8"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="15" BorderBrush="#FF9900" 
                                                BorderThickness="1" Padding="12,5" Margin="0,0,5,5">
                                            <TextBlock Text="{Binding}" Foreground="#FF9900" FontSize="12"/>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Grid>

                    <!-- Synopsis -->
                    <Border Background="#252535" CornerRadius="8" Padding="20" Margin="0,10,0,0">
                        <StackPanel Spacing="8">
                            <TextBlock Text="Synopsis" FontWeight="SemiBold" Foreground="White" FontSize="16"/>
                            <TextBlock Text="{Binding ViewModel.Description}" 
                                       Foreground="#A6ADC8" TextWrapping="Wrap" LineHeight="20" FontSize="13"
                                       MaxLines="4" TextTrimming="CharacterEllipsis"/>
                        </StackPanel>
                    </Border>
                    

                    
                    <!-- Chapter Header -->
                    <Grid ColumnDefinitions="Auto, *, Auto" Margin="0,10,0,5">
                        <TextBlock Text="Chapters" FontWeight="SemiBold" Foreground="White" FontSize="18"/>
                        <Button Grid.Column="2" Command="{Binding ViewModel.DownloadAllCommand}" 
                                Background="#313244" Foreground="#A6E3A1" 
                                CornerRadius="6" Padding="12,6">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" FontSize="14" VerticalAlignment="Center"/>
                                <TextBlock Text="Download All" FontWeight="SemiBold" FontSize="12"/>
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- Loader (Visible when loading chapters) -->
                    <Border Classes="Loader" HorizontalAlignment="Center" Margin="0,30,0,10" 
                            IsVisible="{Binding ViewModel.IsLoadingChapters}"/>
                </StackPanel>
            </DataTemplate>

            <!-- CHAPTER ITEM TEMPLATE -->
            <DataTemplate DataType="vm:ChapterItem">
                <Border Background="Transparent" BorderBrush="#313244" BorderThickness="0,0,0,1" Margin="40,0,40,0">
                    <Grid>
                        <!-- Last Read Indicator -->
                        <Border Width="4" HorizontalAlignment="Left" Background="#FF9900"
                                IsVisible="{Binding IsLastRead}" Margin="0,10"/>
                                
                        <Grid ColumnDefinitions="*, Auto" Margin="15,16,10,16">
                            <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                <TextBlock Text="{Binding Title}" Classes.Unread="{Binding !IsRead}" Classes.Read="{Binding IsRead}" FontSize="15"/>
                                <TextBlock Text="{Binding Date}" Foreground="#6C7086" FontSize="12" Margin="0,4,0,0"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                                <!-- Download Button -->
                                <Button Background="Transparent" Foreground="#CDD6F4" 
                                        CornerRadius="20" Padding="8"
                                        Command="{Binding DownloadCommand}"
                                        ToolTip.Tip="Download">
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#313244"/>
                                        </Style>
                                    </Button.Styles>
                                    <Panel>
                                        <!-- Normal Download Icon -->
                                        <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" FontSize="18"
                                                   IsVisible="{Binding !IsDownloading}">
                                            <TextBlock.IsVisible>
                                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                    <Binding Path="!IsDownloading"/>
                                                    <Binding Path="!IsDownloaded"/>
                                                </MultiBinding>
                                            </TextBlock.IsVisible>
                                        </TextBlock>
                                        
                                        <!-- Check for Downloaded -->
                                        <TextBlock Text="&#xE73E;" FontFamily="Segoe Fluent Icons" FontSize="18"
                                                   IsVisible="{Binding IsDownloaded}" Foreground="#A6E3A1"/>
                                        
                                        <!-- Animated Arrow for Downloading -->
                                        <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" Foreground="#FF9900" FontSize="18"
                                                   IsVisible="{Binding IsDownloading}"
                                                   RenderTransformOrigin="50%,50%">
                                             <TextBlock.Styles>
                                                 <Style Selector="TextBlock[IsVisible=True]">
                                                     <Style.Animations>
                                                         <Animation Duration="0:0:0.6" IterationCount="Infinite" PlaybackDirection="Alternate" Easing="SineEaseInOut"> 
                                                             <KeyFrame KeyTime="0:0:0">
                                                                 <Setter Property="TranslateTransform.Y" Value="-2"/>
                                                                 <Setter Property="Opacity" Value="0.6"/>
                                                             </KeyFrame>
                                                             <KeyFrame KeyTime="0:0:0.6">
                                                                 <Setter Property="TranslateTransform.Y" Value="2"/>
                                                                 <Setter Property="Opacity" Value="1"/>
                                                             </KeyFrame>
                                                         </Animation>
                                                     </Style.Animations>
                                                 </Style>
                                             </TextBlock.Styles>
                                        </TextBlock>
                                    </Panel>
                                </Button>

                                <!-- Delete Button -->
                                <Button Background="Transparent" Foreground="#F38BA8" 
                                        CornerRadius="20" Padding="8"
                                        Command="{Binding DeleteCommand}"
                                        IsVisible="{Binding IsDownloaded}"
                                        ToolTip.Tip="Delete Download">
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#313244"/>
                                        </Style>
                                    </Button.Styles>
                                    <TextBlock Text="&#xE74D;" FontFamily="Segoe Fluent Icons" FontSize="18"/>
                                </Button>
                                
                                <!-- Read Button -->
                                <Button Content="Read" Background="#313244" 
                                        Foreground="#FF9900" CornerRadius="18" Padding="20,8" 
                                        BorderThickness="0" FontWeight="Bold" Cursor="Hand"
                                        HorizontalAlignment="Left"
                                        Click="OnReadClick">
                                    <Button.Styles>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#FF9900"/>
                                            <Setter Property="Foreground" Value="#1E1E2E"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
            </DataTemplate>
        </ListBox.DataTemplates>
    </ListBox>
</UserControl>
