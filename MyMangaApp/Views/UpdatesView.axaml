<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:MyMangaApp.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="MyMangaApp.Views.UpdatesView"
             x:DataType="vm:UpdatesViewModel"
             Background="{DynamicResource PrimaryBackground}">
    
    <UserControl.Styles>
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        
        <!-- Card Style -->
        <Style Selector="Border.UpdateCard">
            <Setter Property="Background" Value="{DynamicResource SidebarBackground}"/>
             <Setter Property="Transitions">
                <Transitions>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                    <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.2"/>
                    <BrushTransition Property="Background" Duration="0:0:0.2"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Border.UpdateCard:pointerover">
            <Setter Property="RenderTransform" Value="scale(1.005)"/> 
            <Setter Property="BoxShadow" Value="0 4 12 0 #40000000"/>
            <Setter Property="Background" Value="{DynamicResource HoverBackground}"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </UserControl.Styles>

    <Panel>
        <!-- Online Content -->
        <Panel IsVisible="{Binding !IsOffline}">
            <ScrollViewer Padding="40">
                <StackPanel>
                    <!-- Header -->
                    <StackPanel Margin="0,0,0,30">
                        <StackPanel Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                            <TextBlock Text="&#xE72C;" FontFamily="Segoe Fluent Icons" FontSize="28" 
                                       Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"
                                       RenderOptions.TextRenderingMode="Antialias"/>
                            <TextBlock Text="Updates" FontSize="32" FontWeight="Bold" 
                                       Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"/>
                            
                            <!-- Count Badge -->
                             <Border Background="{DynamicResource SidebarBackground}" CornerRadius="12" Padding="12,4" IsVisible="{Binding HasItems}" VerticalAlignment="Center">
                                <TextBlock Text="{Binding UpdatesCount, StringFormat='{}{0} New Chapters'}" 
                                           Foreground="{DynamicResource SecondaryText}" FontSize="12" VerticalAlignment="Center"/>
                            </Border>
                        </StackPanel>
                        <TextBlock Text="Recent chapters from your library" Foreground="{DynamicResource SecondaryText}" Margin="0,5,0,0" FontSize="14"/>

                         <!-- Actions Row -->
                         <!-- Use Grid to push button to right, similar to LibraryView search row -->
                        <Grid ColumnDefinitions="*, Auto" Margin="0,20,0,0">
                             <Button Grid.Column="1" Command="{Binding RefreshCommand}"
                                     Background="{DynamicResource SidebarBackground}" Foreground="#0078D7" 
                                     CornerRadius="20" Width="40" Height="40" Padding="0"
                                     ToolTip.Tip="Sync Library">
                                 <TextBlock Text="&#xE72C;" FontFamily="Segoe Fluent Icons" 
                                            FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                             </Button>
                        </Grid>
                    </StackPanel>

                    <!-- Updates List (Grouped) -->
                    <ItemsControl ItemsSource="{Binding GroupedUpdates}" IsVisible="{Binding !IsEmpty}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,0,0,25">
                                    <!-- Group Header -->
                                    <Border BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="0,0,0,1" Margin="0,0,0,10" Padding="0,0,0,5">
                                         <TextBlock Text="{Binding Header}" FontSize="16" FontWeight="Bold" Foreground="#0078D7"/>
                                    </Border>
                                    
                                    <!-- Items in Group -->
                                    <ItemsControl ItemsSource="{Binding Items}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Command="{Binding $parent[UserControl].((vm:UpdatesViewModel)DataContext).OpenChapterCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Background="Transparent" BorderThickness="0" HorizontalAlignment="Stretch" Padding="0" Margin="0,0,0,8">
                                                    <Button.Styles>
                                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                                            <Setter Property="Background" Value="Transparent"/>
                                                        </Style>
                                                        <Style Selector="Button:pressed /template/ ContentPresenter">
                                                            <Setter Property="Background" Value="Transparent"/>
                                                        </Style>
                                                    </Button.Styles>
                                                    
                                                    <Button.ContextMenu>
                                                        <ContextMenu>
                                                            <MenuItem Header="Mark previous as read" 
                                                                      Command="{Binding $parent[UserControl].((vm:UpdatesViewModel)DataContext).MarkPrevReadCommand}"
                                                                      CommandParameter="{Binding}"/>
                                                        </ContextMenu>
                                                    </Button.ContextMenu>
                                                    
                                                    <Border Classes="UpdateCard" CornerRadius="12" Padding="12">
                                                        <Grid ColumnDefinitions="Auto, *, Auto">
                                                            <!-- Cover Placeholder / Image -->
                                                            <Border Grid.Column="0" Width="45" Height="65" CornerRadius="6" ClipToBounds="True" Margin="0,0,15,0" Background="#181825">
                                                                <Image Source="{Binding MangaRef.ThumbnailUrl}" Stretch="UniformToFill">
                                                                    <Image.Source>
                                                                         <Bitmap>avares://MyMangaApp/Assets/placeholder_cover.png</Bitmap>
                                                                    </Image.Source>
                                                                </Image>
                                                            </Border>
                                                            
                                                            <!-- Info -->
                                                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                                                <TextBlock Text="{Binding MangaRef.Title}" Foreground="{DynamicResource PrimaryText}" FontWeight="Bold" FontSize="15" TextTrimming="CharacterEllipsis"/>
                                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                                    <TextBlock Text="{Binding Title}" Foreground="{DynamicResource SecondaryText}" FontSize="13"/>
                                                                    <Border Background="{DynamicResource OverlayBackground}" CornerRadius="4" Padding="6,1" IsVisible="{Binding IsRead}">
                                                                        <TextBlock Text="READ" FontSize="10" Foreground="{DynamicResource SecondaryText}"/>
                                                                    </Border>
                                                                </StackPanel>
                                                            </StackPanel>
                                                            
                                                            <!-- Metadata / Actions -->
                                                            <StackPanel Grid.Column="2" VerticalAlignment="Center" Orientation="Horizontal" Spacing="15" Margin="0,0,10,0">
                                                                <TextBlock Text="{Binding Date}" Foreground="{DynamicResource SecondaryText}" FontSize="12" VerticalAlignment="Center"/>
                                                                
                                                                <TextBlock Text="&#xE896;" FontFamily="Segoe Fluent Icons" Foreground="{DynamicResource SecondaryText}" FontSize="16"
                                                                           IsVisible="{Binding IsDownloaded}" 
                                                                           ToolTip.Tip="Downloaded" VerticalAlignment="Center"/>
                                                                           
                                                                <TextBlock Text="&#xE762;" FontFamily="Segoe Fluent Icons" Foreground="#89B4FA" FontSize="16"
                                                                           IsVisible="{Binding !IsRead}" 
                                                                           ToolTip.Tip="New Chapter" VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

            <!-- Empty State (Centered Overlay) -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20" IsVisible="{Binding IsEmpty}">
                  <!-- Case 1: Library Is Empty -->
                   <StackPanel Spacing="10" IsVisible="{Binding IsLibraryEmpty}">
                       <TextBlock Text="&#xE72C;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#45475A" HorizontalAlignment="Center"/>
                       <TextBlock Text="Updates is Empty" FontSize="20" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                       <TextBlock Text="Add manga to your library to see updates here." Foreground="{DynamicResource SecondaryText}" HorizontalAlignment="Center"/>
                       <Button Command="{Binding GoToLibraryCommand}" Content="Go to Library" HorizontalAlignment="Center" Background="#89B4FA" Foreground="#1E1E2E" Padding="20,10" CornerRadius="8" Margin="0,15,0,0"/>
                   </StackPanel>

                  <!-- Case 2: Library Has Items but No Updates -->
                  <StackPanel Spacing="10" IsVisible="{Binding !IsLibraryEmpty}">
                       <TextBlock Text="&#xE9D5;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#45475A" HorizontalAlignment="Center"/>
                       <TextBlock Text="No Recent Updates" FontSize="20" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                       <TextBlock Text="New chapters from your library will appear here." Foreground="{DynamicResource SecondaryText}" HorizontalAlignment="Center"/>
                       <Button Command="{Binding RefreshCommand}" Content="Check Now" HorizontalAlignment="Center" Background="#89B4FA" Foreground="#1E1E2E" Padding="20,10" CornerRadius="8" Margin="0,15,0,0"/>
                  </StackPanel>
            </StackPanel>
        </Panel>

        <!-- Offline State -->
        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20" IsVisible="{Binding IsOffline}">
            <TextBlock Text="&#xEB55;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#F38BA8" HorizontalAlignment="Center"/>
            <StackPanel Spacing="8">
                <TextBlock Text="No Internet Connection" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                <TextBlock Text="You are currently offline. Please check your network settings." Foreground="{DynamicResource SecondaryText}" FontSize="14" HorizontalAlignment="Center"/>
            </StackPanel>
        </StackPanel>
    </Panel>
</UserControl>
