<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Yomic.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Yomic.Views.HistoryView"
             x:DataType="vm:HistoryViewModel"
             Background="{DynamicResource PrimaryBackground}">

    <Panel>

        <!-- Online Content -->
        <Panel IsVisible="{Binding !IsOffline}">
            <ScrollViewer Padding="40" IsVisible="{Binding HasItems}">
                <StackPanel>
                    <!-- Header -->
                    <StackPanel Margin="0,0,0,30">
                        <StackPanel Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                            <TextBlock Text="&#xE81C;" FontFamily="Segoe Fluent Icons" FontSize="28" 
                                       Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"
                                       RenderOptions.TextRenderingMode="Antialias"/>
                            <TextBlock Text="History" FontSize="32" FontWeight="Bold" 
                                       Foreground="{DynamicResource PrimaryText}" VerticalAlignment="Center"/>
                            
                            <!-- Item Count Badge -->
                             <Border Background="{DynamicResource SidebarBackground}" CornerRadius="12" Padding="12,4" IsVisible="{Binding HasItems}" VerticalAlignment="Center">
                                <TextBlock Text="{Binding HistoryItems.Count, StringFormat='{}{0} Items'}" 
                                           Foreground="{DynamicResource SecondaryText}" FontSize="12" VerticalAlignment="Center"/>
                            </Border>
                        </StackPanel>
                        <TextBlock Text="Recently viewed manga" Foreground="{DynamicResource SecondaryText}" Margin="0,5,0,0" FontSize="14"/>

                        <!-- Action Row -->
                        <Grid ColumnDefinitions="*, Auto" Margin="0,20,0,0">
                             
                             <!-- Refresh/Clear Actions -->
                             <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                                 <Button Command="{Binding ClearHistoryCommand}"
                                         Background="#FF4545" Foreground="White" CornerRadius="20" Padding="20,8" FontWeight="Bold"
                                         ToolTip.Tip="Delete All History">
                                         <StackPanel Orientation="Horizontal" Spacing="8">
                                             <TextBlock Text="&#xE74D;" FontFamily="Segoe Fluent Icons" VerticalAlignment="Center"/>
                                             <TextBlock Text="Clear All" VerticalAlignment="Center"/>
                                         </StackPanel>
                                 </Button>
                                 <Button Command="{Binding RefreshCommand}"
                                         Background="{DynamicResource SidebarBackground}" Foreground="#FF9900" 
                                         CornerRadius="20" Width="40" Height="40" Padding="0"
                                         ToolTip.Tip="Refresh History">
                                         <TextBlock Text="&#xE72C;" FontFamily="Segoe Fluent Icons" 
                                                    FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                 </Button>
                             </StackPanel>
                        </Grid>
                    </StackPanel>

                    <!-- Content -->
                    <ItemsControl ItemsSource="{Binding HistoryItems}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                 <Button Background="Transparent" Padding="0" Margin="0,0,25,30"
                                         Command="{Binding $parent[UserControl].((vm:HistoryViewModel)DataContext).OpenMangaCommand}"
                                         CommandParameter="{Binding}">
                                     <Button.Styles>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Style>
                                     </Button.Styles>

                                     <Button.ContextMenu>
                                         <ContextMenu>
                                             <MenuItem Header="Remove from History" 
                                                       Command="{Binding $parent[UserControl].((vm:HistoryViewModel)DataContext).RemoveHistoryItemCommand}"
                                                       CommandParameter="{Binding}"
                                                       Foreground="#FF5555">
                                                 <MenuItem.Icon>
                                                     <TextBlock Text="&#xE74D;" FontFamily="Segoe Fluent Icons"/>
                                                 </MenuItem.Icon>
                                             </MenuItem>
                                         </ContextMenu>
                                     </Button.ContextMenu>
                                     
                                    <StackPanel Width="150" Spacing="10">
                                        <!-- Cover Image -->
                                        <Border Width="150" Height="225" CornerRadius="12" 
                                                Background="{DynamicResource SidebarBackground}" ClipToBounds="True"
                                                BoxShadow="0 4 10 0 #40000000">
                                            
                                            <Border.Styles>
                                                <Style Selector="Border:pointerover">
                                                    <Setter Property="RenderTransform" Value="scale(1.02) translateY(-4px)"/>
                                                    <Setter Property="BoxShadow" Value="0 10 20 0 #60000000"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </Style>
                                                <Style Selector="Border">
                                                    <Setter Property="Transitions">
                                                        <Transitions>
                                                            <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                                                            <BoxShadowsTransition Property="BoxShadow" Duration="0:0:0.2"/>
                                                        </Transitions>
                                                    </Setter>
                                                </Style>
                                            </Border.Styles>
                                            
                                            <Grid>
                                                <Image Source="{Binding CoverBitmap}" Stretch="UniformToFill"/>
                                                
                                                <!-- Status Badge -->
                                                <Border Background="{Binding StatusString, Converter={x:Static vm:StatusToColorConverter.Instance}}" 
                                                        Opacity="0.95" CornerRadius="6" 
                                                        HorizontalAlignment="Left" VerticalAlignment="Top"
                                                        Margin="8" Padding="6,3">
                                                    <TextBlock Text="{Binding StatusString}" Foreground="White" 
                                                               FontSize="9" FontWeight="Bold"/>
                                                </Border>
                                                
                                                <!-- Last Read Badge -->
                                                <Border Background="{DynamicResource OverlayBackground}" Opacity="0.9" CornerRadius="6" 
                                                        HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                        Margin="8" Padding="6,4">
                                                    <TextBlock Text="{Binding LastReadTime}" Foreground="{DynamicResource PrimaryText}" 
                                                               FontSize="10" FontWeight="SemiBold"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <!-- Title Below Image -->
                                        <TextBlock Text="{Binding Title}" Foreground="{DynamicResource PrimaryText}" 
                                                   TextAlignment="Left" TextTrimming="CharacterEllipsis"
                                                   FontSize="14" FontWeight="Medium" MaxLines="2" Height="40"/>
                                    </StackPanel>
                                 </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

            <!-- Empty State -->
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20" IsVisible="{Binding !HasItems}">
                <TextBlock Text="&#xE81C;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#45475A" HorizontalAlignment="Center"/>
                <StackPanel Spacing="8">
                    <TextBlock Text="No History Yet" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                    <TextBlock Text="Read some manga to see them here." FontSize="14" Foreground="{DynamicResource SecondaryText}" HorizontalAlignment="Center"/>
                </StackPanel>
            </StackPanel>
        </Panel>

        <!-- Offline State -->
        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20" IsVisible="{Binding IsOffline}">
            <TextBlock Text="&#xEB55;" FontFamily="Segoe Fluent Icons" FontSize="64" Foreground="#F38BA8" HorizontalAlignment="Center"/>
            <StackPanel Spacing="8">
                <TextBlock Text="No Internet Connection" FontSize="20" FontWeight="Bold" Foreground="{DynamicResource PrimaryText}" HorizontalAlignment="Center"/>
                <TextBlock Text="You are currently offline. Please check your network settings." Foreground="{DynamicResource SecondaryText}" FontSize="14" HorizontalAlignment="Center"/>
            </StackPanel>
        </StackPanel>
    </Panel>
</UserControl>
